const DATA_ENTRY_SHEET_NAME = "Sheet1";  // TÃªn Sheet cá»§a báº¡n (vÃ­ dá»¥: Sheet1)
const TIME_STAMP_COLUMN_NAME = "Timestamp"; // TÃªn cá»™t Ä‘á»ƒ lÆ°u thá»i gian gá»­i form

const TELEGRAM_BOT_TOKEN = 'your-telegram-bot-token'; // Thay báº±ng token bot cá»§a báº¡n
const TELEGRAM_CHAT_ID = 'your-chat-id'; // Thay báº±ng chat ID cá»§a báº¡n

// Láº¥y Ä‘á»‘i tÆ°á»£ng Sheet theo tÃªn Ä‘Ã£ Ä‘á»‹nh nghÄ©a
var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(DATA_ENTRY_SHEET_NAME);

// HÃ m xá»­ lÃ½ khi cÃ³ request POST
const doPost = (request = {}) => {
  const { postData: { contents, type } = {} } = request;
  
  // Gá»i hÃ m phÃ¢n tÃ­ch vÃ  lÆ°u dá»¯ liá»‡u vÃ o Google Sheets
  var data = parseFormData(contents);
  appendToGoogleSheet(data);
  
  // Gá»­i dá»¯ liá»‡u Ä‘áº¿n Telegram
  sendTelegramMessage(data);

  // Tráº£ vá» káº¿t quáº£ JSON Ä‘á»ƒ hiá»ƒn thá»‹ tráº¡ng thÃ¡i xá»­ lÃ½
  return ContentService.createTextOutput(JSON.stringify({ status: 'Success', data })).setMimeType(ContentService.MimeType.JSON);
};

// HÃ m phÃ¢n tÃ­ch dá»¯ liá»‡u gá»­i Ä‘áº¿n tá»« form
function parseFormData(postData) {
  var data = {};
  var parameters = postData.split('&');
  
  for (var i = 0; i < parameters.length; i++) {
    var keyValue = parameters[i].split('=');
    var key = decodeURIComponent(keyValue[0]).replace(/\+/g, ' '); // Xá»­ lÃ½ tÃªn trÆ°á»ng
    var value = decodeURIComponent(keyValue[1] || '').replace(/\+/g, ' '); // Xá»­ lÃ½ giÃ¡ trá»‹
    key = key.replace(/\[\]/g, "");
    data[key] = value;
  }
  return data;
}

// HÃ m lÆ°u dá»¯ liá»‡u vÃ o Google Sheets
function appendToGoogleSheet(data) {
  if (!sheet) {
    throw new Error("Sheet khÃ´ng tá»“n táº¡i. Vui lÃ²ng kiá»ƒm tra láº¡i tÃªn sheet.");
  }

  // Kiá»ƒm tra vÃ  thÃªm thá»i gian náº¿u cÃ³ trÆ°á»ng Timestamp
  if (TIME_STAMP_COLUMN_NAME !== "") {
    data[TIME_STAMP_COLUMN_NAME] = new Date().toLocaleString(); // LÆ°u thá»i gian vá»›i Ä‘á»‹nh dáº¡ng dá»… Ä‘á»c hÆ¡n
  }

  // Láº¥y tiÃªu Ä‘á» cá»§a cÃ¡c cá»™t trong Google Sheets
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  // Táº¡o máº£ng dá»¯ liá»‡u theo thá»© tá»± tiÃªu Ä‘á» cá»§a cÃ¡c cá»™t
  var rowData = headers.map(headerFld => {
    var cleanHeaderFld = headerFld.trim();
    return data[cleanHeaderFld] || ""; // Náº¿u khÃ´ng cÃ³ giÃ¡ trá»‹ thÃ¬ Ä‘á»ƒ trá»‘ng
  });

  // ThÃªm dÃ²ng dá»¯ liá»‡u má»›i vÃ o Google Sheets
  sheet.appendRow(rowData);
}

// HÃ m gá»­i tin nháº¯n Ä‘áº¿n Telegram
function sendTelegramMessage(data) {
  var message = `ğŸš— *THÃ”NG TIN ÄÆ N Äáº¶T XE Má»šI* ğŸš—\n\n` +
                `ğŸ›¤ï¸ *Äiá»ƒm Ä‘Ã³n*: ${data['diemdon']}\n` +
                `ğŸ *Äiá»ƒm Ä‘áº¿n*: ${data['diemden']}\n` +
                `ğŸ” *Chiá»u di chuyá»ƒn*: ${data['haichieu'] === '1 Chiá»u' ? 'Má»™t chiá»u' : 'Khá»© há»“i'}\n` +
                `ğŸ‘¤ *TÃªn khÃ¡ch hÃ ng*: ${data['your-name']}\n` +
                `ğŸ“ *Sá»‘ Ä‘iá»‡n thoáº¡i*: [${data['your-tel']}](tel:${data['your-tel']})\n` +
                `ğŸš— *Loáº¡i xe*: ${data['chonloaixe']}\n` +
                `ğŸ“… *NgÃ y Ä‘Ã³n*: ${data['ngaydon']}\n` +
                `ğŸ™ï¸ *Äá»‹a chá»‰*: ${data['diachi']}\n` +
                `â° *Thá»i gian Ä‘áº·t*: ${data['Timestamp']}\n`;

  var url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  var payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'Markdown' // Sá»­ dá»¥ng Markdown Ä‘á»ƒ Ä‘á»‹nh dáº¡ng tin nháº¯n
  };

  var options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload)
  };

  UrlFetchApp.fetch(url, options);
}


